{% extends 'tracker/base.html' %}
{% load tracker_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="header">
    <h1>{{ page_title }}</h1>
    <div class="header-actions">
        <button id="openImportModal" class="btn btn-primary" style="margin-right: 10px;">Import Trainees</button>
        <a href="{% url 'advanced_staff_printable_list' %}" class="btn btn-info" target="_blank" style="margin-right: 10px;">Print Staff List</a>
        {% if status_filter == 'removed' %}
            <a href="{% url 'export_advanced_excel_removed' %}" class="btn btn-success">Export to Excel (Removed)</a>
        {% else %}
            <a href="{% url 'export_advanced_excel' %}" class="btn btn-success">Export to Excel (Active)</a>
        {% endif %}
    </div>
</div>

<!-- Filter Controls -->
<div class="filter-controls">
    <div class="filter-group">
        <label for="roleFilter">Role:</label>
        <select id="roleFilter" class="filter-select">
            <option value="">All Roles</option>
            {% for role_code, role_name in role_choices %}
                <option value="{{ role_code }}" {% if role_filter == role_code %}selected{% endif %}>{{ role_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group">
        <label for="statusFilter">Status:</label>
        <select id="statusFilter" class="filter-select">
            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active Only</option>
            <option value="removed" {% if status_filter == 'removed' %}selected{% endif %}>Removed Only</option>
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Staff</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="badgeStatusFilter">Badge Status:</label>
        <select id="badgeStatusFilter" class="filter-select">
            <option value="">All Badge Statuses</option>
            {% for status_code, status_name in badge_status_choices %}
                <option value="{{ status_code }}" {% if badge_status_filter == status_code %}selected{% endif %}>{{ status_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group">
        <label for="hasTraineeFilter">Orientation Record:</label>
        <select id="hasTraineeFilter" class="filter-select">
            <option value="all" {% if has_trainee_filter == 'all' %}selected{% endif %}>All</option>
            <option value="yes" {% if has_trainee_filter == 'yes' %}selected{% endif %}>Has Trainee Record</option>
            <option value="no" {% if has_trainee_filter == 'no' %}selected{% endif %}>No Trainee Record</option>
        </select>
    </div>

    <div class="filter-group">
        <label for="searchBox">Search:</label>
        <input type="text" id="searchBox" class="search-input" placeholder="Name or badge number...">
    </div>

    <button id="clearFilters" class="btn btn-secondary">Clear Filters</button>
</div>

<!-- Training Table - UPDATED v2 -->
<div class="content">
    <div class="table-container">
        <table class="training-table" id="trainingTable">
            <thead>
                <tr>
                    <th class="sticky-col">Badge</th>
                    <th class="sticky-col">Badge Status</th>
                    <th class="sticky-col">Role</th>
                    <th class="sticky-col">Name</th>
                    {% for training_type in training_types %}
                        <th class="training-col" title="{{ training_type.name }}">
                            {{ training_type.name }}
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for item in staff_progress %}
                    <tr class="staff-row"
                        data-badge="{{ item.staff.badge_number }}"
                        data-name="{{ item.staff.get_full_name|lower }}"
                        data-role="{{ item.staff.role }}"
                        data-badge-status="{{ item.staff.badge_status }}"
                        data-active="{{ item.staff.is_active|lower }}">
                        <td class="sticky-col">
                            <a href="{% url 'advanced_staff_detail' item.staff.badge_number %}">
                                {{ item.staff.badge_number }}
                            </a>
                        </td>
                        <td class="sticky-col badge-status-cell">
                            <select class="badge-status-select status-{{ item.staff.badge_status }}"
                                    data-staff-id="{{ item.staff.id }}"
                                    data-original="{{ item.staff.badge_status }}">
                                {% for status_code, status_name in badge_status_choices %}
                                    <option value="{{ status_code }}" {% if item.staff.badge_status == status_code %}selected{% endif %}>{{ status_name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="sticky-col role-cell">
                            <select class="role-select"
                                    data-staff-id="{{ item.staff.id }}"
                                    data-original="{{ item.staff.role }}">
                                {% for role_code, role_name in role_choices %}
                                    <option value="{{ role_code }}" {% if item.staff.role == role_code %}selected{% endif %}>{{ role_name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="sticky-col">{{ item.staff.get_full_name }}</td>
                        {% for training_type in training_types %}
                            <td class="training-cell"
                                data-staff-id="{{ item.staff.id }}"
                                data-staff-badge="{{ item.staff.badge_number }}"
                                data-staff-name="{{ item.staff.get_full_name }}"
                                data-training-type-id="{{ training_type.id }}"
                                data-training-type-name="{{ training_type.name }}"
                                data-allows-custom="{{ training_type.allows_custom_type|lower }}">
                                {% if training_type.id in item.trainings_by_type %}
                                    {% for training in item.trainings_by_type|get_item:training_type.id %}
                                        <div class="training-indicator
                                            {% if not training.completion_date %}status-none
                                            {% elif training.is_expired %}status-expired
                                            {% elif training.is_expiring_soon %}status-expiring
                                            {% else %}status-current{% endif %}"
                                            data-training-id="{{ training.id }}"
                                            data-completion-date="{{ training.completion_date|date:'Y-m-d' }}"
                                            data-approver="{{ training.approver_initials }}"
                                            data-termination-date="{{ training.termination_date|date:'Y-m-d' }}"
                                            data-custom-type="{{ training.custom_type }}"
                                            data-notes="{{ training.notes }}"
                                            title="{{ training_type.name }}{% if training.custom_type %} ({{ training.custom_type }}){% endif %}
Completed: {{ training.completion_date|date:'Y-m-d'|default:'N/A' }}
Approver: {{ training.approver_initials|default:'N/A' }}
{% if training.termination_date %}Expires: {{ training.termination_date|date:'Y-m-d' }}{% endif %}
Click to edit">
                                            {% if not training.completion_date %}-
                                            {% elif training.is_expired %}❌
                                            {% elif training.is_expiring_soon %}⚠️
                                            {% else %}✓{% endif %}
                                            <br><small>{{ training.approver_initials }}</small>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="training-indicator status-none" title="Click to add training">
                                        <span class="add-icon">+</span>
                                    </div>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="{{ training_types|length|add:4 }}" style="text-align: center; padding: 40px;">
                            No staff members found.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Training Edit/Add Modal -->
<div id="trainingModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Edit Training</h2>
            <button class="modal-close" onclick="closeTrainingModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="trainingForm">
                <input type="hidden" id="staffId">
                <input type="hidden" id="trainingTypeId">
                <input type="hidden" id="trainingId">

                <div class="form-row">
                    <div class="form-group">
                        <label>Staff:</label>
                        <input type="text" id="staffDisplay" readonly class="readonly-input">
                    </div>
                    <div class="form-group">
                        <label>Training Type:</label>
                        <input type="text" id="trainingTypeDisplay" readonly class="readonly-input">
                    </div>
                </div>

                <div class="form-group" id="customTypeGroup" style="display: none;">
                    <label for="customType">Custom Type:</label>
                    <input type="text" id="customType" placeholder="e.g., Package, Experiment, Waste">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="completionDate">Completion Date: *</label>
                        <input type="date" id="completionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="approverInitials">Approver Initials:</label>
                        <input type="text" id="approverInitials" value="{{ user_initials }}" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                        <small class="form-help">Auto-filled with your initials</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="terminationDate">Termination/Expiration Date:</label>
                    <input type="date" id="terminationDate">
                    <small class="form-help">Leave blank if training doesn't expire</small>
                </div>

                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes" rows="3" placeholder="Optional notes..."></textarea>
                </div>

                <div id="formError" class="error-message" style="display: none;"></div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-danger" id="deleteBtn" style="display: none;" onclick="deleteTraining()">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTrainingModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner" style="display: none;">
    <div class="spinner"></div>
</div>

<style>
/* Header and Controls */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.filter-controls {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: bold;
    font-size: 14px;
}

.filter-select, .search-input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 14px;
}

/* Badge status dropdown in table cells */
.badge-status-cell {
    padding: 4px !important;
}

.badge-status-select {
    font-size: 11px;
    padding: 3px 5px;
    border: 1px solid #ddd;
    border-radius: 3px;
    background: white;
    min-width: 130px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s, color 0.2s;
}

.badge-status-select:hover {
    border-color: #007bff;
}

.badge-status-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

/* Badge status color coding */
.badge-status-select.status-badging_in_progress {
    background-color: #ffc107;
    color: #000;
    border-color: #ff9800;
}

.badge-status-select.status-ready_to_issue {
    background-color: #17a2b8;
    color: white;
    border-color: #117a8b;
}

.badge-status-select.status-issued_active {
    background-color: #28a745;
    color: white;
    border-color: #1e7e34;
}

.badge-status-select.status-terminated {
    background-color: #dc3545;
    color: white;
    border-color: #bd2130;
}

.badge-status-select.status-onboarding_halted {
    background-color: #6c757d;
    color: white;
    border-color: #545b62;
}

/* Role dropdown in table cells */
.role-cell {
    padding: 4px !important;
}

.role-select {
    font-size: 11px;
    padding: 3px 5px;
    border: 1px solid #ddd;
    border-radius: 3px;
    background: white;
    min-width: 100px;
    cursor: pointer;
    transition: border-color 0.2s;
}

.role-select:hover {
    border-color: #007bff;
}

.role-select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.search-input {
    min-width: 250px;
}

/* Table Styling */
.table-container {
    overflow-x: auto;
    overflow-y: auto;
    max-height: calc(100vh - 300px);
    border: 1px solid #ddd;
    border-radius: 5px;
}

.training-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.training-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #4CAF50;
}

.training-table th {
    background-color: #4CAF50;
    color: white;
    font-weight: bold;
    padding: 12px 8px;
    text-align: left;
    border: 1px solid #45a049;
}

.training-table th.sticky-col {
    position: sticky;
    left: 0;
    z-index: 11;
    background-color: #4CAF50;
}

.training-table td {
    padding: 8px;
    border: 1px solid #ddd;
    text-align: center;
}

.training-table td.sticky-col {
    position: sticky;
    left: 0;
    background-color: white;
    z-index: 5;
    text-align: left;
}

.training-table tr:nth-child(even) td.sticky-col {
    background-color: #f2f2f2;
}

.training-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.training-table tr:hover td {
    background-color: #e8f5e9;
}

.training-table tr.filtered-out {
    display: none;
}

/* Training Cell Indicators */
.training-cell {
    cursor: pointer;
    position: relative;
    min-width: 80px;
}

.training-cell:hover {
    background-color: #fff3cd !important;
}

.training-indicator {
    display: inline-block;
    padding: 5px 8px;
    border-radius: 3px;
    font-weight: bold;
    transition: all 0.2s;
}

.status-current {
    color: #28a745;
    background: #d4edda;
}

.status-expiring {
    color: #fd7e14;
    background: #fff3cd;
}

.status-expired {
    color: #dc3545;
    background: #f8d7da;
}

.status-none {
    color: #6c757d;
    background: #e9ecef;
}

.add-icon {
    font-size: 20px;
    color: #007bff;
}

/* Modal Styling */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #ddd;
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 30px;
    cursor: pointer;
    color: #999;
    line-height: 1;
    padding: 0;
    width: 30px;
    height: 30px;
}

.modal-close:hover {
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
}

/* Form Styling */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 15px;
}

.form-group label {
    font-weight: bold;
    font-size: 14px;
}

.form-group input,
.form-group textarea,
.form-group select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 14px;
}

.readonly-input {
    background-color: #f8f9fa;
    cursor: not-allowed;
}

.form-help {
    color: #6c757d;
    font-size: 12px;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 10px;
    border-radius: 3px;
    margin-bottom: 15px;
}

/* Button Styling */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

/* Loading Spinner */
.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .filter-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .search-input {
        min-width: auto;
    }
}
</style>

<script>
// Global variables
let currentTrainingData = {};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Attach click handlers to training cells
    document.querySelectorAll('.training-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            openTrainingModal(this);
        });
    });

    // Filter event listeners
    document.getElementById('roleFilter').addEventListener('change', applyFilters);
    document.getElementById('badgeStatusFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', function() {
        const role = document.getElementById('roleFilter').value;
        const status = this.value;
        const badgeStatus = document.getElementById('badgeStatusFilter').value;
        const hasTrainee = document.getElementById('hasTraineeFilter').value;
        window.location.href = `?role=${role}&status=${status}&badge_status=${badgeStatus}&has_trainee=${hasTrainee}`;
    });
    document.getElementById('hasTraineeFilter').addEventListener('change', function() {
        const role = document.getElementById('roleFilter').value;
        const status = document.getElementById('statusFilter').value;
        const badgeStatus = document.getElementById('badgeStatusFilter').value;
        const hasTrainee = this.value;
        window.location.href = `?role=${role}&status=${status}&badge_status=${badgeStatus}&has_trainee=${hasTrainee}`;
    });
    document.getElementById('searchBox').addEventListener('input', applyFilters);
    document.getElementById('clearFilters').addEventListener('click', clearFilters);

    // Helper function to update badge status dropdown color
    function updateBadgeStatusColor(selectElement, status) {
        // Remove all status classes
        selectElement.classList.remove('status-badging_in_progress', 'status-ready_to_issue',
                                       'status-issued_active', 'status-terminated', 'status-onboarding_halted');
        // Add the current status class
        selectElement.classList.add('status-' + status);
    }

    // Badge status dropdown change handlers
    document.querySelectorAll('.badge-status-select').forEach(select => {
        select.addEventListener('change', async function() {
            const staffId = this.dataset.staffId;
            const newStatus = this.value;
            const originalStatus = this.dataset.original;
            const selectElement = this;

            // Get staff name from the row for personalized message
            const row = selectElement.closest('tr');
            const staffName = row.querySelector('td:nth-child(3)').textContent.trim();

            // Check if new status requires confirmation
            if (newStatus === 'terminated' || newStatus === 'onboarding_halted') {
                const confirmMessage = `This will mark ${staffName} as inactive and remove them from active staff lists. This action will affect their access to training records. Are you sure?`;

                if (!confirm(confirmMessage)) {
                    // User cancelled - revert dropdown
                    selectElement.value = originalStatus;
                    updateBadgeStatusColor(selectElement, originalStatus);
                    return;
                }
            }

            // Update color immediately for responsive feedback
            updateBadgeStatusColor(selectElement, newStatus);

            try {
                const response = await fetch('{% url "update_advanced_staff_status" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        staff_id: parseInt(staffId),
                        badge_status: newStatus
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update the data attributes
                    selectElement.dataset.original = newStatus;
                    selectElement.closest('tr').dataset.badgeStatus = newStatus;

                    // Update row's is_active attribute if it changed
                    if (result.is_active !== undefined) {
                        row.dataset.active = result.is_active.toString();

                        // Optional: Visual feedback for inactive staff
                        if (!result.is_active) {
                            row.style.opacity = '0.6';
                        } else {
                            row.style.opacity = '1.0';
                        }
                    }
                } else {
                    // Revert to original value on error
                    selectElement.value = originalStatus;
                    updateBadgeStatusColor(selectElement, originalStatus);
                    alert(result.error || 'Failed to update badge status');
                }
            } catch (error) {
                // Revert to original value on error
                selectElement.value = originalStatus;
                updateBadgeStatusColor(selectElement, originalStatus);
                alert('Error updating badge status: ' + error.message);
            }
        });
    });

    // Role dropdown change handlers
    document.querySelectorAll('.role-select').forEach(select => {
        select.addEventListener('change', async function() {
            const staffId = this.dataset.staffId;
            const newRole = this.value;
            const originalRole = this.dataset.original;
            const selectElement = this;

            try {
                const response = await fetch('{% url "update_advanced_staff_role" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        staff_id: parseInt(staffId),
                        role: newRole
                    })
                });

                const result = await response.json();
                if (result.success) {
                    selectElement.dataset.original = newRole;
                    selectElement.closest('tr').dataset.role = newRole;
                } else {
                    selectElement.value = originalRole;
                    alert(result.error || 'Failed to update role');
                }
            } catch (error) {
                selectElement.value = originalRole;
                alert('Error updating role: ' + error.message);
            }
        });
    });

    // Form submission
    document.getElementById('trainingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveTraining();
    });

    // Close modal on overlay click
    document.getElementById('trainingModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeTrainingModal();
        }
    });

    // Escape key to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('trainingModal').style.display !== 'none') {
            closeTrainingModal();
        }
    });
});

// Open training modal
function openTrainingModal(cell) {
    const staffId = cell.dataset.staffId;
    const staffBadge = cell.dataset.staffBadge;
    const staffName = cell.dataset.staffName;
    const trainingTypeId = cell.dataset.trainingTypeId;
    const trainingTypeName = cell.dataset.trainingTypeName;
    const allowsCustom = cell.dataset.allowsCustom === 'true';

    // Find existing training indicator
    const indicator = cell.querySelector('.training-indicator[data-training-id]');
    const isEdit = indicator && indicator.dataset.trainingId;

    // Populate modal
    document.getElementById('staffId').value = staffId;
    document.getElementById('trainingTypeId').value = trainingTypeId;
    document.getElementById('staffDisplay').value = `${staffBadge} - ${staffName}`;
    document.getElementById('trainingTypeDisplay').value = trainingTypeName;

    // Show/hide custom type field
    const customTypeGroup = document.getElementById('customTypeGroup');
    if (allowsCustom) {
        customTypeGroup.style.display = 'block';
    } else {
        customTypeGroup.style.display = 'none';
    }

    if (isEdit) {
        // Editing existing training
        document.getElementById('modalTitle').textContent = 'Edit Training';
        document.getElementById('trainingId').value = indicator.dataset.trainingId;
        document.getElementById('completionDate').value = indicator.dataset.completionDate || '';
        // approverInitials field is read-only and always shows current user's initials
        document.getElementById('terminationDate').value = indicator.dataset.terminationDate || '';
        document.getElementById('customType').value = indicator.dataset.customType || '';
        document.getElementById('notes').value = indicator.dataset.notes || '';
        document.getElementById('deleteBtn').style.display = 'inline-block';
    } else {
        // Adding new training
        document.getElementById('modalTitle').textContent = 'Add Training';
        document.getElementById('trainingId').value = '';
        document.getElementById('completionDate').value = '';
        // approverInitials field is read-only and always shows current user's initials
        document.getElementById('terminationDate').value = '';
        document.getElementById('customType').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('deleteBtn').style.display = 'none';
    }

    // Clear error
    document.getElementById('formError').style.display = 'none';

    // Show modal
    document.getElementById('trainingModal').style.display = 'flex';

    // Store current cell reference
    currentTrainingData.cell = cell;
}

// Close training modal
function closeTrainingModal() {
    document.getElementById('trainingModal').style.display = 'none';
    currentTrainingData = {};
}

// Save training
async function saveTraining() {
    const formError = document.getElementById('formError');
    formError.style.display = 'none';

    // Gather form data (approver_initials auto-populated by backend from logged-in user)
    const data = {
        staff_id: parseInt(document.getElementById('staffId').value),
        training_type_id: parseInt(document.getElementById('trainingTypeId').value),
        completion_date: document.getElementById('completionDate').value,
        termination_date: document.getElementById('terminationDate').value || null,
        custom_type: document.getElementById('customType').value.trim(),
        notes: document.getElementById('notes').value.trim(),
    };

    // Validation
    if (!data.completion_date) {
        formError.textContent = 'Completion date is required.';
        formError.style.display = 'block';
        return;
    }

    // Show loading
    document.getElementById('loadingSpinner').style.display = 'flex';

    try {
        const response = await fetch('{% url "update_advanced_training" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            // Update the cell visually
            updateCellDisplay(currentTrainingData.cell, result.training, data);
            closeTrainingModal();
        } else {
            formError.textContent = result.error || 'An error occurred while saving.';
            formError.style.display = 'block';
        }
    } catch (error) {
        formError.textContent = 'Network error: ' + error.message;
        formError.style.display = 'block';
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
}

// Update cell display after successful save
function updateCellDisplay(cell, trainingData, formData) {
    const trainingId = document.getElementById('trainingId').value;

    // Determine status class
    let statusClass = 'status-current';
    let statusIcon = '✓';

    if (!trainingData.completion_date) {
        statusClass = 'status-none';
        statusIcon = '-';
    } else if (trainingData.is_expired) {
        statusClass = 'status-expired';
        statusIcon = '❌';
    } else if (trainingData.is_expiring_soon) {
        statusClass = 'status-expiring';
        statusIcon = '⚠️';
    }

    // Build title (use trainingData for approver_initials from server)
    const trainingTypeName = cell.dataset.trainingTypeName;
    let titleText = `${trainingTypeName}`;
    if (formData.custom_type) {
        titleText += ` (${formData.custom_type})`;
    }
    titleText += `\nCompleted: ${formData.completion_date || 'N/A'}`;
    titleText += `\nApprover: ${trainingData.approver_initials || 'N/A'}`;
    if (formData.termination_date) {
        titleText += `\nExpires: ${formData.termination_date}`;
    }
    titleText += '\nClick to edit';

    // Create new indicator HTML (use trainingData for approver_initials from server)
    const indicatorHTML = `
        <div class="training-indicator ${statusClass}"
            data-training-id="${trainingData.id}"
            data-completion-date="${formData.completion_date}"
            data-approver="${trainingData.approver_initials}"
            data-termination-date="${formData.termination_date || ''}"
            data-custom-type="${formData.custom_type}"
            data-notes="${formData.notes}"
            title="${titleText}">
            ${statusIcon}
            <br><small>${trainingData.approver_initials}</small>
        </div>
    `;

    // Replace cell content
    cell.innerHTML = indicatorHTML;
}

// Delete training
async function deleteTraining() {
    const trainingId = document.getElementById('trainingId').value;

    if (!trainingId || !confirm('Are you sure you want to delete this training record?')) {
        return;
    }

    document.getElementById('loadingSpinner').style.display = 'flex';

    try {
        const response = await fetch(`{% url 'delete_advanced_training' 0 %}`.replace('/0/', `/${trainingId}/`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        const result = await response.json();

        if (result.success) {
            // Replace with empty cell
            currentTrainingData.cell.innerHTML = '<div class="training-indicator status-none" title="Click to add training"><span class="add-icon">+</span></div>';
            closeTrainingModal();
        } else {
            alert('Error deleting training: ' + result.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
}

// Apply filters
function applyFilters() {
    const roleFilter = document.getElementById('roleFilter').value.toLowerCase();
    const badgeStatusFilter = document.getElementById('badgeStatusFilter').value;
    const searchText = document.getElementById('searchBox').value.toLowerCase();

    document.querySelectorAll('.staff-row').forEach(row => {
        const badge = row.dataset.badge.toLowerCase();
        const name = row.dataset.name.toLowerCase();
        const role = row.dataset.role.toLowerCase();
        const badgeStatus = row.dataset.badgeStatus;

        const roleMatch = !roleFilter || role === roleFilter;
        const badgeStatusMatch = !badgeStatusFilter || badgeStatus === badgeStatusFilter;
        const searchMatch = !searchText || name.includes(searchText) || badge.includes(searchText);

        if (roleMatch && badgeStatusMatch && searchMatch) {
            row.classList.remove('filtered-out');
        } else {
            row.classList.add('filtered-out');
        }
    });
}

// Clear filters
function clearFilters() {
    document.getElementById('roleFilter').value = '';
    document.getElementById('badgeStatusFilter').value = '';
    document.getElementById('searchBox').value = '';
    applyFilters();
}
</script>

<!-- Import Trainees Modal -->
<div id="importTraineesModal" class="modal-overlay" style="display: none;">
    <div class="modal-content import-trainee-modal">
        <h2>Import Trainees to Advanced Training</h2>
        <p style="margin-bottom: 15px; color: #666;">Select trainees to import. Staff with incomplete training (< 100%) will show a warning.</p>

        <!-- Search box -->
        <input type="text" id="traineeSearchInput" class="search-input" placeholder="Search by badge number or name..." style="margin-bottom: 15px; width: 100%;">

        <!-- Loading spinner -->
        <div id="traineeLoadingSpinner" style="text-align: center; padding: 40px;">
            <div class="progress-spinner"></div>
            <p>Loading trainees...</p>
        </div>

        <!-- Trainee list -->
        <div id="traineeImportList" class="trainee-import-list" style="display: none;">
            <!-- Trainees will be populated here via JavaScript -->
        </div>

        <!-- Selected count and actions -->
        <div class="import-modal-actions">
            <span id="selectedImportCount">0 selected</span>
            <button id="confirmImportBtn" class="btn btn-primary">Import Selected</button>
            <button id="cancelImportBtn" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<style>
/* Import modal styles */
.import-trainee-modal {
    width: 700px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.trainee-import-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 15px;
}

.trainee-import-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.trainee-import-item:hover {
    background-color: #f5f5f5;
}

.trainee-import-item:last-child {
    border-bottom: none;
}

.trainee-import-item input[type="checkbox"] {
    margin-right: 12px;
    cursor: pointer;
}

.trainee-import-item .badge {
    font-weight: bold;
    margin-right: 12px;
    min-width: 60px;
}

.trainee-import-item .name {
    flex: 1;
    margin-right: 12px;
}

.trainee-import-item .progress {
    margin-right: 8px;
    font-size: 14px;
}

.trainee-import-item .progress.complete {
    color: green;
}

.trainee-import-item .progress.incomplete {
    color: #ff6b6b;
    font-weight: bold;
}

.trainee-import-item .warning-icon {
    color: #ff9800;
    font-size: 18px;
}

.import-modal-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 15px;
    border-top: 1px solid #ddd;
}

#selectedImportCount {
    font-weight: bold;
    color: #333;
}
</style>

<script>
// Import Trainees Modal Logic
(function() {
    const modal = document.getElementById('importTraineesModal');
    const openBtn = document.getElementById('openImportModal');
    const cancelBtn = document.getElementById('cancelImportBtn');
    const confirmBtn = document.getElementById('confirmImportBtn');
    const traineeList = document.getElementById('traineeImportList');
    const loadingSpinner = document.getElementById('traineeLoadingSpinner');
    const searchInput = document.getElementById('traineeSearchInput');
    const selectedCountSpan = document.getElementById('selectedImportCount');

    let allTrainees = [];
    let selectedTraineeIds = new Set();

    // Open modal and fetch trainees
    openBtn.addEventListener('click', function() {
        modal.style.display = 'flex';
        fetchTrainees();
    });

    // Close modal
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });

    function closeModal() {
        modal.style.display = 'none';
        selectedTraineeIds.clear();
        updateSelectedCount();
    }

    // Fetch trainees from server
    function fetchTrainees() {
        traineeList.style.display = 'none';
        loadingSpinner.style.display = 'block';

        fetch('{% url "get_trainees_for_import" %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allTrainees = data.trainees;
                    renderTrainees(allTrainees);
                    loadingSpinner.style.display = 'none';
                    traineeList.style.display = 'block';
                } else {
                    alert('Error loading trainees: ' + data.error);
                    closeModal();
                }
            })
            .catch(error => {
                alert('Error loading trainees: ' + error);
                closeModal();
            });
    }

    // Render trainee list
    function renderTrainees(trainees) {
        traineeList.innerHTML = '';

        if (trainees.length === 0) {
            traineeList.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">No trainees found.</p>';
            return;
        }

        trainees.forEach(trainee => {
            const item = document.createElement('div');
            item.className = 'trainee-import-item';
            item.dataset.traineeId = trainee.id;
            item.dataset.badge = trainee.badge_number.toLowerCase();
            item.dataset.name = trainee.full_name.toLowerCase();

            const isComplete = trainee.progress_percentage === 100;
            const progressClass = isComplete ? 'complete' : 'incomplete';

            item.innerHTML = `
                <input type="checkbox" class="trainee-import-checkbox" data-id="${trainee.id}">
                <span class="badge">${trainee.badge_number}</span>
                <span class="name">${trainee.full_name}</span>
                <span class="progress ${progressClass}">${trainee.progress_percentage}%</span>
                ${!isComplete ? '<span class="warning-icon">⚠️</span>' : ''}
            `;

            traineeList.appendChild(item);

            // Add click handler for checkbox
            const checkbox = item.querySelector('.trainee-import-checkbox');
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedTraineeIds.add(parseInt(this.dataset.id));
                } else {
                    selectedTraineeIds.delete(parseInt(this.dataset.id));
                }
                updateSelectedCount();
            });

            // Allow clicking the whole item to toggle checkbox
            item.addEventListener('click', function(e) {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        });
    }

    // Search/filter trainees
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const items = traineeList.querySelectorAll('.trainee-import-item');

        items.forEach(item => {
            const badge = item.dataset.badge;
            const name = item.dataset.name;

            if (badge.includes(searchTerm) || name.includes(searchTerm)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // Update selected count
    function updateSelectedCount() {
        const count = selectedTraineeIds.size;
        selectedCountSpan.textContent = `${count} selected`;
    }

    // Confirm import
    confirmBtn.addEventListener('click', function() {
        if (selectedTraineeIds.size === 0) {
            alert('Please select at least one trainee to import.');
            return;
        }

        // Check if any selected trainees are incomplete
        const selectedTrainees = allTrainees.filter(t => selectedTraineeIds.has(t.id));
        const incompleteTrainees = selectedTrainees.filter(t => t.progress_percentage < 100);

        if (incompleteTrainees.length > 0) {
            const message = `Warning: ${incompleteTrainees.length} trainee(s) have incomplete training:\n\n` +
                incompleteTrainees.map(t => `${t.badge_number} ${t.full_name} (${t.progress_percentage}%)`).join('\n') +
                '\n\nImport anyway?';

            if (!confirm(message)) {
                return;
            }
        }

        // Proceed with import
        importTrainees();
    });

    // Import trainees via AJAX
    function importTrainees() {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Importing...';

        fetch('{% url "import_trainees_to_advanced" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                trainee_ids: Array.from(selectedTraineeIds)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `Successfully imported ${data.imported} trainee(s)!`;

                if (data.incomplete && data.incomplete.length > 0) {
                    message += `\n\nNote: ${data.incomplete.length} trainee(s) had incomplete training:\n` +
                        data.incomplete.map(t => `${t.badge} ${t.name} (${t.progress})`).join('\n');
                }

                alert(message);
                closeModal();
                location.reload(); // Reload to show new staff
            } else {
                if (data.duplicates) {
                    const duplicateList = data.duplicates.map(d => `${d.badge} ${d.name}`).join('\n');
                    alert(`Error: Cannot import - badge numbers already exist in Advanced Training:\n\n${duplicateList}\n\nPlease check the Advanced Training staff list.`);
                } else {
                    alert('Error: ' + data.error);
                }
            }
        })
        .catch(error => {
            alert('Error importing trainees: ' + error);
        })
        .finally(() => {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Import Selected';
        });
    }
})();
</script>

{% endblock %}
