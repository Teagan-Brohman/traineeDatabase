{% extends 'tracker/base.html' %}

{% block title %}{{ trainee.full_name }} - Badge Tracker{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    {% if from_cohort %}
        <a href="{% url 'archive_detail' from_cohort.id %}" class="btn">← Back to Archive ({{ from_cohort.name }})</a>
        <a href="{% url 'trainee_list' %}" class="btn" style="margin-left: 10px;">Back to Main List</a>
    {% else %}
        <a href="{% url 'trainee_list' %}" class="btn">← Back to List</a>
    {% endif %}
</div>

<div class="card">
    <h2>{{ trainee.full_name }}</h2>
    <p><strong>Badge Number:</strong> {{ trainee.badge_number }}</p>
    <p><strong>Cohort:</strong> {{ trainee.cohort }}</p>
    <p><strong>Overall Progress:</strong></p>
    <div class="progress-bar" style="max-width: 400px;">
        <div class="progress-bar-fill" style="width: {{ progress_percentage }}%;">
            {{ progress_percentage }}%
        </div>
    </div>
</div>

<div class="card">
    <h3>Training Tasks</h3>

    <!-- Bulk Operations Toolbar for Detail View -->
    <div id="bulkToolbarDetail" class="bulk-toolbar" style="display: none; margin-bottom: 15px;">
        <div class="bulk-toolbar-content">
            <span id="selectedTaskCount" class="bulk-selected-count">0 tasks selected</span>
            <button id="bulkSignOffTasksBtn" class="btn btn-primary">Bulk Sign-Off Selected Tasks</button>
            <button id="clearTaskSelectionBtn" class="btn">Clear Selection</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAllTasks" title="Select all unsigned tasks">
                </th>
                <th style="width: 50px;">#</th>
                <th>Task</th>
                <th>Category</th>
                <th>Status</th>
                <th>Signed By</th>
                <th>Date</th>
                <th>Score</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in task_progress %}
            <tr class="task-row" data-task-id="{{ item.task.id }}">
                <td>
                    {% if not item.signoff and item.can_sign_off %}
                        <input type="checkbox" class="task-checkbox"
                               data-task-id="{{ item.task.id }}"
                               data-task-name="{{ item.task.name }}"
                               data-requires-score="{{ item.task.requires_score }}"
                               data-min-score="{{ item.task.minimum_score|default:'' }}">
                    {% endif %}
                </td>
                <td>{{ item.task.order }}</td>
                <td>
                    {{ item.task.name }}
                    {% if item.task.description %}
                        <br><small style="color: #666;">{{ item.task.description }}</small>
                    {% endif %}
                </td>
                <td>{{ item.task.category|default:"-" }}</td>
                <td>
                    {% if item.signoff %}
                        <span class="completed">✓ Completed</span>
                    {% else %}
                        <span class="pending">Pending</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.signoff %}
                        {{ item.signoff.signed_by.get_full_name|default:item.signoff.signed_by.username }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.signoff %}
                        {{ item.signoff.signed_at|date:"m/d/Y g:i A" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if item.signoff and item.signoff.score %}
                        {{ item.signoff.score }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if not item.signoff %}
                        {% if item.can_sign_off %}
                            <button onclick="openSignOffModal('{{ item.task.id }}', '{{ item.task.name|escapejs }}', {{ item.task.requires_score|yesno:'true,false' }}, '{{ item.task.minimum_score|default:'' }}')" class="btn btn-success">
                                Sign Off
                            </button>
                        {% else %}
                            <button class="btn" disabled title="You are not authorized to sign off this task">
                                Not Authorized
                            </button>
                        {% endif %}
                    {% else %}
                        <div style="display: flex; gap: 5px;">
                            {% if item.can_sign_off %}
                                <button onclick="openSignOffModal('{{ item.task.id }}', '{{ item.task.name|escapejs }}', {{ item.task.requires_score|yesno:'true,false' }}, '{{ item.task.minimum_score|default:'' }}')" class="btn">
                                    Update
                                </button>
                            {% endif %}
                            {% if item.can_unsign %}
                                <button onclick="openUnsignModal('{{ item.task.id }}', '{{ item.task.name|escapejs }}')" class="btn btn-danger btn-small">
                                    Unsign
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" style="text-align: center;">No tasks configured. Add tasks in the admin panel.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Sign Off Modal -->
<div id="signOffModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 id="modalTitle">Sign Off Task</h3>
        <form method="POST" id="signOffForm">
            {% csrf_token %}
            <div style="margin: 20px 0;">
                <label for="score" style="display: block; margin-bottom: 5px;">Score (if applicable):</label>
                <input type="text" name="score" id="score" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin: 20px 0;">
                <label for="notes" style="display: block; margin-bottom: 5px;">Notes:</label>
                <textarea name="notes" id="notes" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeSignOffModal()" class="btn" style="background: #95a5a6;">Cancel</button>
                <button type="submit" class="btn btn-success">Confirm Sign Off</button>
            </div>
        </form>
    </div>
</div>

<script>
function openSignOffModal(taskId, taskName, requiresScore, minScore) {
    document.getElementById('modalTitle').textContent = 'Sign Off: ' + taskName;
    document.getElementById('signOffForm').action = '{% url 'trainee_detail' trainee.badge_number %}'.replace('{{ trainee.badge_number }}', '{{ trainee.badge_number }}') + 'signoff/' + taskId + '/';

    const scoreField = document.getElementById('score');
    const scoreLabel = scoreField.parentElement.querySelector('label');

    if (requiresScore) {
        scoreField.parentElement.style.display = 'block';

        // Update label to show minimum score if set
        if (minScore && minScore !== '') {
            scoreLabel.innerHTML = 'Score (required - minimum: ' + minScore + '):';
            scoreField.setAttribute('required', 'required');
            scoreField.setAttribute('min', minScore);
            scoreField.setAttribute('type', 'number');
            scoreField.setAttribute('step', '0.01');
        } else {
            scoreLabel.textContent = 'Score (if applicable):';
            scoreField.removeAttribute('required');
            scoreField.removeAttribute('min');
            scoreField.setAttribute('type', 'text');
        }
    } else {
        scoreField.parentElement.style.display = 'none';
        scoreField.removeAttribute('required');
    }

    document.getElementById('signOffModal').style.display = 'block';
}

function closeSignOffModal() {
    document.getElementById('signOffModal').style.display = 'none';
    document.getElementById('signOffForm').reset();
}

// Close modal when clicking outside - wait for DOM to load
document.addEventListener('DOMContentLoaded', function() {
    const signOffModal = document.getElementById('signOffModal');
    if (signOffModal) {
        signOffModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSignOffModal();
            }
        });
    }

    const unsignModal = document.getElementById('unsignModal');
    if (unsignModal) {
        unsignModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeUnsignModal();
            }
        });
    }
});

// Unsign Modal Functions
function openUnsignModal(taskId, taskName) {
    document.getElementById('unsignModalTitle').textContent = 'Remove Sign-Off: ' + taskName;
    document.getElementById('unsignForm').action = '{% url 'trainee_detail' trainee.badge_number %}'.replace('{{ trainee.badge_number }}', '{{ trainee.badge_number }}') + 'unsign/' + taskId + '/';
    document.getElementById('unsignModal').style.display = 'block';
}

function closeUnsignModal() {
    document.getElementById('unsignModal').style.display = 'none';
    document.getElementById('unsignForm').reset();
}

// ========================================
// BULK OPERATIONS FOR TRAINEE DETAIL
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    const bulkToolbarDetail = document.getElementById('bulkToolbarDetail');
    const selectedTaskCountSpan = document.getElementById('selectedTaskCount');
    const bulkSignOffTasksBtn = document.getElementById('bulkSignOffTasksBtn');
    const clearTaskSelectionBtn = document.getElementById('clearTaskSelectionBtn');
    const selectAllTasksCheckbox = document.getElementById('selectAllTasks');
    const taskCheckboxes = document.querySelectorAll('.task-checkbox');

    // Safety checks - exit if critical elements don't exist
    if (!bulkToolbarDetail || !selectAllTasksCheckbox || !selectedTaskCountSpan ||
        !bulkSignOffTasksBtn || !clearTaskSelectionBtn) {
        console.warn('Bulk operations: Some required elements not found');
        console.log('Elements found:', {
            toolbar: !!bulkToolbarDetail,
            selectAll: !!selectAllTasksCheckbox,
            countSpan: !!selectedTaskCountSpan,
            signOffBtn: !!bulkSignOffTasksBtn,
            clearBtn: !!clearTaskSelectionBtn,
            checkboxCount: taskCheckboxes.length
        });
        return;
    }

    // Track selected tasks (Map: taskId -> task data)
    let selectedTasks = new Map();

    // Update UI when task selection changes
    function updateBulkTaskUI() {
        const count = selectedTasks.size;

        if (count > 0) {
            bulkToolbarDetail.style.display = 'block';
            selectedTaskCountSpan.textContent = `${count} task${count !== 1 ? 's' : ''} selected`;
        } else {
            bulkToolbarDetail.style.display = 'none';
        }

        // Update select all checkbox state
        const allSelected = taskCheckboxes.length > 0 && Array.from(taskCheckboxes).every(cb => cb.checked);
        selectAllTasksCheckbox.checked = allSelected;
    }

    // Handle individual task checkbox changes
    taskCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const taskId = this.dataset.taskId;
            const taskName = this.dataset.taskName;
            const requiresScore = this.dataset.requiresScore === 'True';
            const minScore = this.dataset.minScore;

            if (this.checked) {
                selectedTasks.set(taskId, {id: taskId, name: taskName, requiresScore: requiresScore, minScore: minScore});
            } else {
                selectedTasks.delete(taskId);
            }

            updateBulkTaskUI();
        });
    });

    // Handle select all tasks checkbox
    selectAllTasksCheckbox.addEventListener('change', function() {
        if (this.checked) {
            taskCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
                const taskId = checkbox.dataset.taskId;
                const taskName = checkbox.dataset.taskName;
                const requiresScore = checkbox.dataset.requiresScore === 'True';
                const minScore = checkbox.dataset.minScore;
                selectedTasks.set(taskId, {id: taskId, name: taskName, requiresScore: requiresScore, minScore: minScore});
            });
        } else {
            taskCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedTasks.clear();
        }

        updateBulkTaskUI();
    });

    // Clear task selection
    clearTaskSelectionBtn.addEventListener('click', function() {
        taskCheckboxes.forEach(cb => cb.checked = false);
        selectedTasks.clear();
        updateBulkTaskUI();
    });

    // Show bulk task sign-off modal
    bulkSignOffTasksBtn.addEventListener('click', function() {
        if (selectedTasks.size === 0) {
            alert('Please select at least one task.');
            return;
        }

        showBulkTaskSignOffModal();
    });

    // Bulk Task Sign-Off Modal
    function showBulkTaskSignOffModal() {
        const tasksArray = Array.from(selectedTasks.values());
        const hasScoreRequirements = tasksArray.some(t => t.requiresScore);

        // Create score inputs for tasks that require scores
        let scoreInputsHTML = '';
        if (hasScoreRequirements) {
            scoreInputsHTML = '<div class="form-group"><strong>Scores Required:</strong></div>';
            tasksArray.filter(t => t.requiresScore).forEach(task => {
                scoreInputsHTML += `
                    <div class="form-group">
                        <label for="score_${task.id}">${task.name}:${task.minScore ? ` (min: ${task.minScore})` : ''}</label>
                        <input type="text" id="score_${task.id}" class="form-control score-input"
                               data-task-id="${task.id}" placeholder="e.g., 95" required>
                    </div>
                `;
            });
        }

        // Create modal overlay
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content bulk-modal">
                <h2>Bulk Sign-Off Tasks</h2>
                <p><strong>${selectedTasks.size} task${selectedTasks.size !== 1 ? 's' : ''} for {{ trainee.full_name }}:</strong></p>
                <div class="selected-trainees-list">
                    ${tasksArray.map(t => `<div>${t.name}${t.requiresScore ? ' (Score Required)' : ''}</div>`).join('')}
                </div>

                ${scoreInputsHTML}

                <div class="form-group">
                    <label for="bulkTaskNotesInput">Notes (optional):</label>
                    <textarea id="bulkTaskNotesInput" class="form-control" rows="3" placeholder="Enter any notes..."></textarea>
                </div>

                <div class="modal-actions">
                    <button id="confirmBulkTaskSignOff" class="btn btn-primary">Sign Off ${selectedTasks.size} Task${selectedTasks.size !== 1 ? 's' : ''}</button>
                    <button id="cancelBulkTaskSignOff" class="btn">Cancel</button>
                </div>

                <div id="bulkTaskProgress" class="bulk-progress" style="display: none;">
                    <div class="progress-spinner"></div>
                    <p>Processing sign-offs...</p>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Handle confirmation
        document.getElementById('confirmBulkTaskSignOff').addEventListener('click', async function() {
            const notes = document.getElementById('bulkTaskNotesInput').value.trim();

            // Collect scores
            const scores = {};
            let hasErrors = false;

            tasksArray.forEach(task => {
                if (task.requiresScore) {
                    const scoreInput = document.getElementById(`score_${task.id}`);
                    const score = scoreInput ? scoreInput.value.trim() : '';

                    if (!score) {
                        alert(`Score required for task: ${task.name}`);
                        hasErrors = true;
                        return;
                    }

                    if (task.minScore) {
                        const scoreValue = parseFloat(score);
                        const minScore = parseFloat(task.minScore);
                        if (scoreValue < minScore) {
                            alert(`Score for "${task.name}" must be at least ${minScore}`);
                            hasErrors = true;
                            return;
                        }
                    }

                    scores[task.id] = score;
                }
            });

            if (hasErrors) return;

            // Show progress
            document.getElementById('bulkTaskProgress').style.display = 'block';
            this.disabled = true;

            // Prepare data
            const data = {
                trainee_ids: [{{ trainee.id }}],
                task_ids: tasksArray.map(t => parseInt(t.id)),
                scores: scores,
                notes: notes
            };

            try {
                const response = await fetch('{% url "bulk_sign_off" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                });

                // Check if response is OK (status 200-299)
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server returned ${response.status}: ${errorText.substring(0, 200)}`);
                }

                // Try to parse JSON response
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    const responseText = await response.text();
                    throw new Error(`Expected JSON response but got: ${responseText.substring(0, 200)}`);
                }

                if (result.success) {
                    alert(`Success!\n\nCreated: ${result.created}\nUpdated: ${result.updated}\n${result.skipped.length > 0 ? `Skipped: ${result.skipped.length}` : ''}`);
                    document.body.removeChild(modal);
                    location.reload(); // Reload to show updated tasks
                } else {
                    // Safely handle errors array that might be undefined
                    const errorDetails = result.errors && result.errors.length > 0
                        ? '\n\n' + result.errors.map(e => `${e.task}: ${e.error}`).join('\n')
                        : '';
                    alert(`Error: ${result.error}${errorDetails}`);
                    document.getElementById('bulkTaskProgress').style.display = 'none';
                    this.disabled = false;
                }
            } catch (error) {
                alert('An error occurred while processing bulk sign-off:\n\n' + error.message);
                document.getElementById('bulkTaskProgress').style.display = 'none';
                this.disabled = false;
            }
        });

        // Handle cancel
        document.getElementById('cancelBulkTaskSignOff').addEventListener('click', function() {
            document.body.removeChild(modal);
        });

        // Close on overlay click
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
    }
}); // End DOMContentLoaded
</script>

<!-- Unsign Modal -->
<div id="unsignModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 id="unsignModalTitle" style="color: #e74c3c;">Remove Sign-Off</h3>
        <p style="margin: 15px 0; color: #666;">Are you sure you want to remove this sign-off? This action will be logged in the audit trail.</p>
        <form method="POST" id="unsignForm">
            {% csrf_token %}
            <div style="margin: 20px 0;">
                <label for="unsignReason" style="display: block; margin-bottom: 5px;">Reason for removal (optional):</label>
                <textarea name="reason" id="unsignReason" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="e.g., Entered in error, needs re-training"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeUnsignModal()" class="btn" style="background: #95a5a6;">Cancel</button>
                <button type="submit" class="btn btn-danger">Confirm Removal</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
