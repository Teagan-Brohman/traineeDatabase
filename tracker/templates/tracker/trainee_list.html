{% extends 'tracker/base.html' %}

{% block title %}Trainee List - Badge Tracker{% endblock %}

{% block content %}
<div class="card">
    {% if is_archive %}
        <h2>Archived Trainees - {{ cohort.name }}</h2>
        <p>Viewing trainees from {{ cohort.name }} ({{ cohort.start_date|date:"M d, Y" }} - {{ cohort.end_date|date:"M d, Y" }})</p>
        <div style="margin-top: 15px;">
            <a href="{% url 'archive_list' %}" class="btn" style="margin-right: 10px;">‚Üê Back to Archives</a>
            <a href="{% url 'trainee_list' %}" class="btn">View Current Cohort</a>
        </div>
    {% else %}
        <h2>Active Trainees{% if current_cohort %} - {{ current_cohort.name }}{% endif %}</h2>
        <p>Click on a trainee to view detailed progress and sign off tasks.</p>
        {% if current_cohort %}
        <div style="margin-top: 15px;">
            <a href="{% url 'archive_list' %}" class="btn">View Archives</a>
        </div>
        {% endif %}
    {% endif %}
</div>

<!-- Toolbar with Search and View Mode -->
<div class="toolbar">
    <div class="toolbar-left">
        <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Search by badge number or name..."
            autocomplete="off"
        >
        <button id="clearSearch" class="search-clear" style="display: none;">Clear</button>
        <span id="resultCount" class="search-result-count"></span>
    </div>
    <div class="toolbar-right">
        <div class="view-mode-selector">
            <a href="?view=standard" class="view-mode-btn {% if view_mode == 'standard' %}active{% endif %}">Standard</a>
            <a href="?view=compact" class="view-mode-btn {% if view_mode == 'compact' %}active{% endif %}">Compact</a>
            <a href="?view=detailed" class="view-mode-btn {% if view_mode == 'detailed' %}active{% endif %}">Detailed</a>
        </div>
        {% if not is_archive %}
            <a href="{% url 'export_current_cohort' %}" class="btn btn-success" style="margin-left: 15px;">
                Export to Excel
            </a>
        {% else %}
            <a href="{% url 'export_cohort' cohort.id %}" class="btn btn-success" style="margin-left: 15px;">
                Export to Excel
            </a>
        {% endif %}
    </div>
</div>

<div class="{% if view_mode == 'compact' %}compact-view{% elif view_mode == 'detailed' %}detailed-view{% endif %}">
    <table id="traineeTable">
        <thead>
            <tr>
                <th>Badge Number</th>
                <th>Name</th>
                <th>Cohort</th>
                <th class="extra-info">Date Added</th>
                <th>Progress</th>
                <th class="extra-info">Tasks Completed</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="traineeTableBody">
            {% for trainee in trainees %}
            <tr class="trainee-row"
                data-badge="{{ trainee.badge_number|lower }}"
                data-name="{{ trainee.full_name|lower }}"
                data-cohort="{{ trainee.cohort|lower }}">
                <td>{{ trainee.badge_number }}</td>
                <td>{{ trainee.full_name }}</td>
                <td>{{ trainee.cohort }}</td>
                <td class="extra-info">{{ trainee.date_added|date:"m/d/Y" }}</td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: {{ trainee.get_progress_percentage }}%;">
                            {{ trainee.get_progress_percentage }}%
                        </div>
                    </div>
                </td>
                <td class="extra-info">{{ trainee.signoffs.count }} tasks</td>
                <td>
                    <a href="{% url 'trainee_detail' trainee.badge_number %}" class="btn">View Details</a>
                </td>
            </tr>
            {% empty %}
            <tr id="noTraineesRow">
                <td colspan="7" style="text-align: center;">No active trainees found. Add trainees in the admin panel.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="noResultsMessage" style="display: none; text-align: center; padding: 40px; background: white; margin-top: 20px; border-radius: 8px;">
        <p style="font-size: 18px; color: #666;">No trainees match your search.</p>
    </div>
</div>

<script>
// Client-side search functionality
const searchInput = document.getElementById('searchInput');
const clearButton = document.getElementById('clearSearch');
const resultCount = document.getElementById('resultCount');
const traineeRows = document.querySelectorAll('.trainee-row');
const noResultsMessage = document.getElementById('noResultsMessage');
const traineeTable = document.getElementById('traineeTable');

function filterTrainees() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;

    traineeRows.forEach(row => {
        const badge = row.dataset.badge;
        const name = row.dataset.name;
        const cohort = row.dataset.cohort;

        // Check if search term matches badge number, name, or cohort
        const matches = badge.includes(searchTerm) ||
                       name.includes(searchTerm) ||
                       cohort.includes(searchTerm);

        if (matches) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Update UI
    if (searchTerm) {
        clearButton.style.display = 'inline-block';
        resultCount.textContent = `${visibleCount} result${visibleCount !== 1 ? 's' : ''} found`;
    } else {
        clearButton.style.display = 'none';
        resultCount.textContent = '';
    }

    // Show/hide no results message
    if (visibleCount === 0 && searchTerm && traineeRows.length > 0) {
        noResultsMessage.style.display = 'block';
        traineeTable.style.display = 'none';
    } else {
        noResultsMessage.style.display = 'none';
        traineeTable.style.display = 'table';
    }
}

function clearSearch() {
    searchInput.value = '';
    filterTrainees();
    searchInput.focus();
}

// Event listeners
searchInput.addEventListener('input', filterTrainees);
clearButton.addEventListener('click', clearSearch);

// Allow clearing with Escape key
searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        clearSearch();
    }
});
</script>
{% endblock %}
