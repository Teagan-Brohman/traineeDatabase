{% extends 'tracker/base.html' %}

{% block title %}Trainee List - Badge Tracker{% endblock %}

{% block content %}
<div class="card">
    {% if is_archive %}
        <h2>Archived Trainees - {{ cohort.name }}</h2>
        <p>Viewing trainees from {{ cohort.name }} ({{ cohort.start_date|date:"M d, Y" }} - {{ cohort.end_date|date:"M d, Y" }})</p>
        <div style="margin-top: 15px;">
            <a href="{% url 'archive_list' %}" class="btn" style="margin-right: 10px;">‚Üê Back to Archives</a>
            <a href="{% url 'trainee_list' %}" class="btn">View Current Cohort</a>
        </div>
    {% else %}
        <h2>Active Trainees{% if current_cohort %} - {{ current_cohort.name }}{% endif %}</h2>
        <p>Click on a trainee to view detailed progress and sign off tasks.</p>
        {% if current_cohort %}
        <div style="margin-top: 15px;">
            <a href="{% url 'archive_list' %}" class="btn">View Archives</a>
        </div>
        {% endif %}
    {% endif %}
</div>

<!-- Toolbar with Search and View Mode -->
<div class="toolbar">
    <div class="toolbar-left">
        <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Search by badge number or name..."
            autocomplete="off"
        >
        <button id="clearSearch" class="search-clear" style="display: none;">Clear</button>
        <span id="resultCount" class="search-result-count"></span>
    </div>
    <div class="toolbar-right">
        <div class="view-mode-selector">
            <a href="?view=standard" class="view-mode-btn {% if view_mode == 'standard' %}active{% endif %}">Standard</a>
            <a href="?view=compact" class="view-mode-btn {% if view_mode == 'compact' %}active{% endif %}">Compact</a>
            <a href="?view=detailed" class="view-mode-btn {% if view_mode == 'detailed' %}active{% endif %}">Detailed</a>
        </div>
        {% if not is_archive %}
            <a href="{% url 'export_current_cohort' %}" class="btn btn-success" style="margin-left: 15px;">
                Export to Excel
            </a>
        {% else %}
            <a href="{% url 'export_cohort' cohort.id %}" class="btn btn-success" style="margin-left: 15px;">
                Export to Excel
            </a>
        {% endif %}
    </div>
</div>

<!-- Bulk Operations Toolbar -->
<div id="bulkToolbar" class="bulk-toolbar" style="display: none;">
    <div class="bulk-toolbar-content">
        <span id="selectedCount" class="bulk-selected-count">0 trainees selected</span>
        <button id="bulkSignOffBtn" class="btn btn-primary">Bulk Sign-Off</button>
        <button id="clearSelectionBtn" class="btn">Clear Selection</button>
    </div>
</div>

<div class="{% if view_mode == 'compact' %}compact-view{% elif view_mode == 'detailed' %}detailed-view{% endif %}">
    <table id="traineeTable">
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAllTrainees" title="Select all trainees">
                </th>
                <th>Badge Number</th>
                <th>Name</th>
                <th>Cohort</th>
                <th class="extra-info">Date Added</th>
                <th>Progress</th>
                <th class="extra-info">Tasks Completed</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="traineeTableBody">
            {% for trainee in trainees %}
            <tr class="trainee-row"
                data-badge="{{ trainee.badge_number|lower }}"
                data-name="{{ trainee.full_name|lower }}"
                data-cohort="{{ trainee.cohort|lower }}"
                data-trainee-id="{{ trainee.id }}">
                <td>
                    <input type="checkbox" class="trainee-checkbox" data-trainee-id="{{ trainee.id }}" data-trainee-name="{{ trainee.full_name }}" data-badge="{{ trainee.badge_number }}">
                </td>
                <td>{{ trainee.badge_number }}</td>
                <td>{{ trainee.full_name }}</td>
                <td>{{ trainee.cohort }}</td>
                <td class="extra-info">{{ trainee.date_added|date:"m/d/Y" }}</td>
                <td>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: {{ trainee.get_progress_percentage }}%;">
                            {{ trainee.get_progress_percentage }}%
                        </div>
                    </div>
                </td>
                <td class="extra-info">{{ trainee.signoffs.count }} tasks</td>
                <td>
                    <a href="{% url 'trainee_detail' trainee.badge_number %}" class="btn">View Details</a>
                </td>
            </tr>
            {% empty %}
            <tr id="noTraineesRow">
                <td colspan="8" style="text-align: center;">No active trainees found. Add trainees in the admin panel.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="noResultsMessage" style="display: none; text-align: center; padding: 40px; background: white; margin-top: 20px; border-radius: 8px;">
        <p style="font-size: 18px; color: #666;">No trainees match your search.</p>
    </div>
</div>

<script>
// Client-side search functionality
const searchInput = document.getElementById('searchInput');
const clearButton = document.getElementById('clearSearch');
const resultCount = document.getElementById('resultCount');
const traineeRows = document.querySelectorAll('.trainee-row');
const noResultsMessage = document.getElementById('noResultsMessage');
const traineeTable = document.getElementById('traineeTable');

function filterTrainees() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;

    traineeRows.forEach(row => {
        const badge = row.dataset.badge;
        const name = row.dataset.name;
        const cohort = row.dataset.cohort;

        // Check if search term matches badge number, name, or cohort
        const matches = badge.includes(searchTerm) ||
                       name.includes(searchTerm) ||
                       cohort.includes(searchTerm);

        if (matches) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });

    // Update UI
    if (searchTerm) {
        clearButton.style.display = 'inline-block';
        resultCount.textContent = `${visibleCount} result${visibleCount !== 1 ? 's' : ''} found`;
    } else {
        clearButton.style.display = 'none';
        resultCount.textContent = '';
    }

    // Show/hide no results message
    if (visibleCount === 0 && searchTerm && traineeRows.length > 0) {
        noResultsMessage.style.display = 'block';
        traineeTable.style.display = 'none';
    } else {
        noResultsMessage.style.display = 'none';
        traineeTable.style.display = 'table';
    }
}

function clearSearch() {
    searchInput.value = '';
    filterTrainees();
    searchInput.focus();
}

// Event listeners
searchInput.addEventListener('input', filterTrainees);
clearButton.addEventListener('click', clearSearch);

// Allow clearing with Escape key
searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        clearSearch();
    }
});

// ========================================
// BULK OPERATIONS FUNCTIONALITY
// ========================================

const bulkToolbar = document.getElementById('bulkToolbar');
const selectedCountSpan = document.getElementById('selectedCount');
const bulkSignOffBtn = document.getElementById('bulkSignOffBtn');
const clearSelectionBtn = document.getElementById('clearSelectionBtn');
const selectAllCheckbox = document.getElementById('selectAllTrainees');
const traineeCheckboxes = document.querySelectorAll('.trainee-checkbox');

// Track selected trainees
let selectedTrainees = new Set();

// Update UI when selection changes
function updateBulkUI() {
    const count = selectedTrainees.size;

    if (count > 0) {
        bulkToolbar.style.display = 'block';
        selectedCountSpan.textContent = `${count} trainee${count !== 1 ? 's' : ''} selected`;
    } else {
        bulkToolbar.style.display = 'none';
    }

    // Update select all checkbox state
    const visibleCheckboxes = Array.from(traineeCheckboxes).filter(cb => cb.closest('.trainee-row').style.display !== 'none');
    const allSelected = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
    selectAllCheckbox.checked = allSelected;
}

// Handle individual checkbox changes
traineeCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const traineeId = this.dataset.traineeId;
        const traineeName = this.dataset.traineeName;
        const badge = this.dataset.badge;

        if (this.checked) {
            selectedTrainees.add({id: traineeId, name: traineeName, badge: badge});
        } else {
            selectedTrainees = new Set(Array.from(selectedTrainees).filter(t => t.id !== traineeId));
        }

        updateBulkUI();
    });
});

// Handle select all checkbox
selectAllCheckbox.addEventListener('change', function() {
    const visibleCheckboxes = Array.from(traineeCheckboxes).filter(cb => cb.closest('.trainee-row').style.display !== 'none');

    if (this.checked) {
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
            const traineeId = checkbox.dataset.traineeId;
            const traineeName = checkbox.dataset.traineeName;
            const badge = checkbox.dataset.badge;
            selectedTrainees.add({id: traineeId, name: traineeName, badge: badge});
        });
    } else {
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            const traineeId = checkbox.dataset.traineeId;
            selectedTrainees = new Set(Array.from(selectedTrainees).filter(t => t.id !== traineeId));
        });
    }

    updateBulkUI();
});

// Clear selection
clearSelectionBtn.addEventListener('click', function() {
    traineeCheckboxes.forEach(cb => cb.checked = false);
    selectedTrainees.clear();
    updateBulkUI();
});

// Show bulk sign-off modal
bulkSignOffBtn.addEventListener('click', function() {
    if (selectedTrainees.size === 0) {
        alert('Please select at least one trainee.');
        return;
    }

    // Open modal
    showBulkSignOffModal();
});

// Bulk Sign-Off Modal
function showBulkSignOffModal() {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content bulk-modal">
            <h2>Bulk Sign-Off</h2>
            <p><strong>${selectedTrainees.size} trainee${selectedTrainees.size !== 1 ? 's' : ''} selected:</strong></p>
            <div class="selected-trainees-list">
                ${Array.from(selectedTrainees).map(t => `<div>${t.badge} - ${t.name}</div>`).join('')}
            </div>

            <div class="form-group">
                <label for="bulkTaskSelect">Select Task to Sign Off:</label>
                <select id="bulkTaskSelect" class="form-control" required>
                    <option value="">-- Select a task --</option>
                    {% for task in tasks %}
                    <option value="{{ task.id }}" data-requires-score="{{ task.requires_score }}" data-min-score="{{ task.minimum_score|default:'' }}">
                        {{ task.order }}. {{ task.name }}{% if task.requires_score %} (Score Required){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" id="bulkScoreGroup" style="display: none;">
                <label for="bulkScoreInput">Score (applies to all trainees):</label>
                <input type="text" id="bulkScoreInput" class="form-control" placeholder="e.g., 95">
                <small id="bulkMinScoreNote" class="form-text"></small>
            </div>

            <div class="form-group">
                <label for="bulkNotesInput">Notes (optional):</label>
                <textarea id="bulkNotesInput" class="form-control" rows="3" placeholder="Enter any notes..."></textarea>
            </div>

            <div class="modal-actions">
                <button id="confirmBulkSignOff" class="btn btn-primary">Sign Off ${selectedTrainees.size} Trainee${selectedTrainees.size !== 1 ? 's' : ''}</button>
                <button id="cancelBulkSignOff" class="btn">Cancel</button>
            </div>

            <div id="bulkProgress" class="bulk-progress" style="display: none;">
                <div class="progress-spinner"></div>
                <p>Processing sign-offs...</p>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Handle task selection
    const taskSelect = document.getElementById('bulkTaskSelect');
    const scoreGroup = document.getElementById('bulkScoreGroup');
    const scoreInput = document.getElementById('bulkScoreInput');
    const minScoreNote = document.getElementById('bulkMinScoreNote');

    taskSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const requiresScore = selectedOption.dataset.requiresScore === 'True';
        const minScore = selectedOption.dataset.minScore;

        if (requiresScore) {
            scoreGroup.style.display = 'block';
            scoreInput.required = true;
            if (minScore) {
                minScoreNote.textContent = `Minimum passing score: ${minScore}`;
            }
        } else {
            scoreGroup.style.display = 'none';
            scoreInput.required = false;
            minScoreNote.textContent = '';
        }
    });

    // Handle confirmation
    document.getElementById('confirmBulkSignOff').addEventListener('click', async function() {
        const taskId = taskSelect.value;
        const score = scoreInput.value.trim();
        const notes = document.getElementById('bulkNotesInput').value.trim();

        if (!taskId) {
            alert('Please select a task.');
            return;
        }

        const selectedOption = taskSelect.options[taskSelect.selectedIndex];
        const requiresScore = selectedOption.dataset.requiresScore === 'True';

        if (requiresScore && !score) {
            alert('This task requires a score.');
            return;
        }

        // Show progress
        document.getElementById('bulkProgress').style.display = 'block';
        this.disabled = true;

        // Prepare data
        const data = {
            trainee_ids: Array.from(selectedTrainees).map(t => parseInt(t.id)),
            task_ids: [parseInt(taskId)],
            scores: score ? {[taskId]: score} : {},
            notes: notes
        };

        try {
            const response = await fetch('{% url "bulk_sign_off" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert(`Success!\n\nCreated: ${result.created}\nUpdated: ${result.updated}\n${result.skipped.length > 0 ? `Skipped: ${result.skipped.length}` : ''}`);
                document.body.removeChild(modal);
                location.reload(); // Reload to show updated progress
            } else {
                alert(`Error: ${result.error}\n\n${result.errors.map(e => `${e.trainee} - ${e.task}: ${e.error}`).join('\n')}`);
                document.getElementById('bulkProgress').style.display = 'none';
                this.disabled = false;
            }
        } catch (error) {
            alert('An error occurred while processing bulk sign-off: ' + error.message);
            document.getElementById('bulkProgress').style.display = 'none';
            this.disabled = false;
        }
    });

    // Handle cancel
    document.getElementById('cancelBulkSignOff').addEventListener('click', function() {
        document.body.removeChild(modal);
    });

    // Close on overlay click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
}
</script>
{% endblock %}
